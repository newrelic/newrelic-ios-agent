import "ConstantsFastfile"

platform :ios do

  desc "Build iOS.xcarchive / iOS Sim framework"
  lane :buildIOS do 
    # Build Device
    xcodebuild(
      clean: true,
      archive: true,
      archive_path: "#{Constants::ARCHIVES}/iOS.xcarchive",
      configuration: "#{Constants::MODE}",
      workspace: "Agent.xcworkspace",
      scheme: "Agent-iOS",
      sdk: "iphoneos",
      derivedDataPath: Constants::DD,
      xcargs: "SKIP_INSTALL=NO BUILD_LIBRARIES_FOR_DISTRIBUTION=YES",
      xcodebuild_formatter: ""
    )
    # Build Sim
    xcodebuild(
      clean: true, 
      build: true,
      configuration: "#{Constants::MODE}",
      workspace: "Agent.xcworkspace",
      scheme: "Agent-iOS",
      sdk: "iphonesimulator",
      derivedDataPath: Constants::DD,
      xcodebuild_formatter: ""
    )
  end

  desc "Build tvOS.xcarchive / tvOS Sim framework"
  lane :buildTVOS do 
    # Build Device
    xcodebuild(
      archive: true,
      archive_path: "#{Constants::ARCHIVES}/tvOS.xcarchive",
      configuration: "#{Constants::MODE}",
      workspace: "Agent.xcworkspace",
      scheme: "Agent-tvOS",
      sdk: "appletvos",
      derivedDataPath: Constants::DD,
      xcargs: "SKIP_INSTALL=NO BUILD_LIBRARIES_FOR_DISTRIBUTION=YES",
      xcodebuild_formatter: ""
    )
    # Build Sim
    xcodebuild(
      build: true, 
      configuration: "#{Constants::MODE}",
      workspace: "Agent.xcworkspace",
      scheme: "Agent-tvOS",
      sdk: "appletvsimulator",
      derivedDataPath: Constants::DD,
      xcodebuild_formatter: ""
    )
  end 

  desc "Build macOS.xcarchive"
  lane :buildMacOS do 

    # The way I goofed previously was using this new code here that doesn't codesign the Mac OS portion of the XCFramework.... Don't do that. Left for historical knowledge.
    # xcodebuild(
    #   archive: true,
    #   archive_path: "#{Constants::ARCHIVES}/macOS.xcarchive",
    #   configuration: "#{Constants::MODE}",
    #   workspace: "Agent.xcworkspace",
    #   scheme: "Agent-iOS",
    #   sdk: "macosx",
    #   derivedDataPath: Constants::DD,
    #   xcargs: "SKIP_INSTALL=NO BUILD_LIBRARIES_FOR_DISTRIBUTION=YES SUPPORTS_MACCATALYST=YES",
    #   xcodebuild_formatter: ""
    # )
    
    # Execute the following, grab the xcarchive and put it in the XCFramework.
    # ./scripts/build_catalyst_agent.sh
    Dir.chdir("..") do
        sh("pwd")
        # change it to take -- "#{Constants::ARCHIVES}/macOS.xcarchive"
        sh("./scripts/build_catalyst_agent.sh")

        sh("pwd")
        sh("mkdir -p \"#{Constants::ARCHIVES}/macOS.xcarchive\"")
        sh("cp -r build/macosx/macosx.xcarchive/. \"#{Constants::ARCHIVES}/macOS.xcarchive\"")
      
        sh("mkdir -p \"#{Constants::ARCHIVES}/macOS.xcarchive/Products/Library/Frameworks/NewRelic.framework\"")

        sh("cp -r build/macosx/NewRelic.framework/. \"#{Constants::ARCHIVES}/macOS.xcarchive/Products/Library/Frameworks/NewRelic.framework\"")
    end
  end
end
