import "ConstantsFastfile"

platform :ios do

  desc "Ouput Universal NewRelicAgent.xcframework"
  lane :internalOutputXCFramework do 
    # Now that we have the iOS.xcarchive, tvOS.xcarchive, and macOS.xcarchive 
    # and the iOS and tvOS Sim Frameworks built in archives and dd folder we can create the xcframework.
    Dir.chdir("..") do
      dirName = File.basename(Dir.getwd)

      wd = Dir.pwd
      iosArchive = "#{wd}/#{Constants::ARCHIVES}/iOS.xcarchive/Products/Library/Frameworks/NewRelicAgent.framework"
      iosDsym = "#{wd}/#{Constants::ARCHIVES}/iOS.xcarchive/dSYMs/NewRelicAgent.framework.dSYM"
      iosSimArchive = "#{wd}/#{Constants::DD}/Build/Products/#{Constants::MODE}-iphonesimulator/NewRelicAgent.framework"

      tvOSArchive = "#{wd}/#{Constants::ARCHIVES}/tvOS.xcarchive/Products/Library/Frameworks/NewRelicAgent.framework"
      tvOSDsym = "#{wd}/#{Constants::ARCHIVES}/tvOS.xcarchive/dSYMs/NewRelicAgent.framework.dSYM"
      tvOSSimArchive = "#{wd}/#{Constants::DD}/Build/Products/#{Constants::MODE}-appletvsimulator/NewRelicAgent.framework"

      watchOSArchive = "#{wd}/#{Constants::ARCHIVES}/watchOS.xcarchive/Products/Library/Frameworks/NewRelicAgent.framework"
      watchOSDsym = "#{wd}/#{Constants::ARCHIVES}/watchOS.xcarchive/dSYMs/NewRelicAgent.framework.dSYM"
      watchOSSimArchive = "#{wd}/#{Constants::DD}/Build/Products/#{Constants::MODE}-watchsimulator/NewRelicAgent.framework"

      macOSArchive = "#{wd}/#{Constants::ARCHIVES}/macOS.xcarchive/Products/Library/Frameworks/NewRelicAgent.framework"
      macOSDsym = "#{wd}/#{Constants::ARCHIVES}/macOS.xcarchive/dSYMs/NewRelicAgent.framework.dSYM"

      create_xcframework(frameworks_with_dsyms: {
        iosArchive => { dsyms: iosDsym },
        iosSimArchive => {},
        tvOSArchive => { dsyms: tvOSDsym },
        tvOSSimArchive => {},
        watchOSArchive => { dsyms: watchOSDsym },
        watchOSSimArchive => {},
        macOSArchive => { dsyms: macOSDsym }
      }, output: "#{dirName}/NewRelicAgent.xcframework")
    end

    codesignFramework

    # copying dsym tools into the xcframework is not going to work out for the mac catalyst build.
    #cpDsymToolsToFramework

  end

  desc "Copy dsym-upload-tools to xcframework"
  lane :cpDsymToolsToFramework do 
    Dir.chdir("..") do
      sh("mkdir -p NewRelicAgent.xcframework/Resources/")
      sh("cp -r dsym-upload-tools/ NewRelicAgent.xcframework/Resources/")
    end
  end
  desc "Codesign xcframework"
  lane :codesignFramework do 
    Dir.chdir("..") do
      sh("codesign --timestamp -v --sign \"Apple Distribution: New Relic Inc (SU7SUNGZJP)\" NewRelicAgent.xcframework")
    end
  end
  # DEBUG LANES
  
  desc "Ouput Universal NewRelicAgent.xcframework for iOS Only"
  lane :internalOutputXCFrameworkIOSOnly do 
    Dir.chdir("..") do
      wd = Dir.pwd
      iosArchive = "#{wd}/#{Constants::ARCHIVES}/iOS.xcarchive/Products/Library/Frameworks/NewRelicAgent.framework"
      iosDsym = "#{wd}/#{Constants::ARCHIVES}/iOS.xcarchive/dSYMs/NewRelicAgent.framework.dSYM"
      iosSimArchive = "#{wd}/#{Constants::DD}/Build/Products/#{Constants::MODE}-iphonesimulator/NewRelicAgent.framework"

      create_xcframework(frameworks_with_dsyms: {
        iosArchive => { dsyms: iosDsym },
        iosSimArchive => {},
      }, output: "dylib-ios-agent/NewRelicAgent.xcframework")
    end

    cpDsymToolsToFramework
  end

end
